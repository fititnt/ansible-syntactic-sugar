---
# FILE:            {{ role_path }}/tasks/main.yml
# LICENSE:         Public Domain

- name: "Welcome message"
  debug:
    msg:
      a2s_version: "{{ a2s_version }}"
      a2s_betatesting: "{{ a2s_betatesting | default(omit) }}"
      a2s_debug: "{{ a2s_debug | default('undefined') }}"
      a2s_internal_no_log: "{{ a2s_debug | default('undefined') }}"
      a2s_only: "{{ a2s_only | default('undefined') }}"
      a2s_except: "{{ a2s_except | default('undefined') }}"
      a2s_autoinstall_dependencies: "{{ a2s_autoinstall_dependencies | default('undefined') }}"
      a2s_autoinstall_repositories: "{{ a2s_autoinstall_repositories | default('undefined') }}"
      a2s_internal_iswindows: "{{ a2s_internal_iswindows | default('undefined') }}"
      ansible_run_tags: "{{ ansible_run_tags | default('undefined') }}"
      ansible_skip_tags: "{{ ansible_skip_tags | default('undefined') }}"
      node:
        os: "{{ ansible_os_family | default('undefined') | lower }}"
        dist: "{{ ansible_distribution | default('undefined') | lower }}"
        dist_release: "{{ ansible_distribution_release | default('undefined') | lower }}"
        dist_major_ver: "{{ ansible_distribution_major_version | default('undefined') | lower }}"
        ansible_lsb: "{{ ansible_lsb | default('undefined') }}"
        # If behind NAT, this may not represent real public IPv4.
        # Alternative: https://docs.ansible.com/ansible/latest/modules/ipify_facts_module.html
        ansible_default_ipv4: "{{ ansible_default_ipv4.address | default('undefined') }}"
  tags:
    - always

## Variable loading based on node Operational System ___________________________
- name: "OS Family variables"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_iswindows is defined and a2s_iswindows|bool) | ternary('os-family/windows.yml', 'name-of-a-file-that-does-not-exist.yml') }}"
    - "{{ (a2s_vars_osfamily is defined) | ternary(a2s_vars_osfamily, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/{{ ansible_os_family | default('undefined') | lower }}.yml"
    - "os-family/{{ (ansible_os_family is defined) | ternary('untested','unknown') }}.yml"
  tags:
    - always

- name: "OS Family version variables"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_osfamilyversion is defined) | ternary(a2s_vars_osfamilyversion, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/os-family-version/{{ ansible_os_family | default('undefined') | lower }}-{{ ansible_distribution_major_version
      | default('undefined')
      | lower }}.yml"
    - "os-family/os-family-version/no-os-family-version-customization.yml"
  tags:
    - always

- name: "Distribution variables (may override OS Family variables, if exist)"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_distribution is defined) | ternary(a2s_vars_distribution, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/distribution/{{ ansible_distribution | default('undefined') | lower }}.yml"
    - "os-family/distribution/no-os-family-customization.yml"
  tags:
    - always

- name: "Specific version distribution variables (may override OS Family and Distribution variables, if exist)"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_distribution_version is defined) | ternary(a2s_vars_distribution_version, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/distribution/version/{{ ansible_distribution | default('undefined') | lower }}-{{ ansible_distribution_major_version
      | default('undefined')
      | lower }}.yml"
    - "os-family/distribution/version/no-distribution-customization.yml"
  tags:
    - always

- name: "Result of pre-calculated variables on this play"
  debug:
    msg:
      a2s_default_user: "{{ a2s_default_user | default('undefined') }}"
      a2s_default_group: "{{ a2s_default_group | default('undefined') }}"
      a2s_default_directory_mode: "{{ a2s_default_directory_mode | default('undefined') }}"
      a2s_default_file_mode: "{{ a2s_default_file_mode | default('undefined') }}"
      a2s_isconteiner: "{{ a2s_isconteiner | default('undefined') }}"
      a2s_install_composer: "{{ a2s_install_composer | default(omit) }}"
      a2s_install_composers: "{{ a2s_install_composers | default(omit) }}"
      a2s_install_php: "{{ a2s_install_php | default(omit) }}"
  tags:
    - always

## Load a2s apis by group ______________________________________________________

- name: "group-packaging-os.yml"
  include: "group-packaging-os.yml"
  when:
    - "(a2s_only_groups is undefined) or ('packaging-os' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('packaging-os' not in a2s_except_groups)"
  tags:
    - a2s-group-packaging-os

- name: "group-system.yml"
  include: "group-system.yml"
  when:
    - "(a2s_only_groups is undefined) or ('system' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('system' not in a2s_except_groups)"
  tags:
    - a2s-group-system

- name: "group-files.yml"
  include: "group-files.yml"
  when:
    - "(a2s_only_groups is undefined) or ('files' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('files' not in a2s_except_groups)"
  tags:
    - a2s-group-files

- name: "group-packaging-languages.yml"
  include: "group-packaging-languages.yml"
  when:
    - "(a2s_only_groups is undefined) or ('packaging-languages' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('packaging-languages' not in a2s_except_groups)"
  tags:
    - a2s-group-packaging-languages

- name: "group-database.yml"
  include: "group-database.yml"
  when:
    - "(a2s_only_groups is undefined) or ('database' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('database' not in a2s_except_groups)"
  tags:
    - a2s-group-database

- name: "group-a2s-devel.yml"
  include: "group-a2s-devel.yml"
  when:
    - "(a2s_only_groups is undefined) or ('a2s-devel' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('a2s-devel' not in a2s_except_groups)"
  tags:
    - a2s-group-a2s-devel

- name: "group-a2s-extra.yml"
  include: "group-a2s-extra.yml"
  when:
    - "(a2s_only_groups is undefined) or ('a2s-extra' in a2s_only_groups)"
    - "(a2s_except_groups is undefined) or ('a2s-extra' not in a2s_except_groups)"
  tags:
    - a2s-group-aa2s-extra
