---
# FILE:            {{ role_path }}/tasks/main.yml
# LICENSE:         Public Domain

- name: "Welcome message"
  debug:
    msg:
      a2s_version: "{{ a2s_version }}"
      a2s_betatesting: "{{ a2s_betatesting | default(omit) }}"
      a2s_autoinstall_dependencies: "{{ a2s_autoinstall_dependencies | default('undefined') }}"
      a2s_autoinstall_repositories: "{{ a2s_autoinstall_repositories | default('undefined') }}"
      a2s_internal_iswindows: "{{ a2s_internal_iswindows | default('undefined') }}"
      node:
        os: "{{ ansible_os_family | default('undefined') | lower }}"
        dist: "{{ ansible_distribution | default('undefined') | lower }}"
        dist_release: "{{ ansible_distribution_release | default('undefined') | lower }}"
        dist_major_ver: "{{ ansible_distribution_major_version | default('undefined') | lower }}"
        ansible_lsb: "{{ ansible_lsb | default('undefined') }}"
        # If behind NAT, this may not represent real public IPv4.
        # Alternative: https://docs.ansible.com/ansible/latest/modules/ipify_facts_module.html
        ansible_default_ipv4: "{{ ansible_default_ipv4.address | default('undefined') }}"
  tags:
    - always

## Variable loading based on node Operational System ___________________________
- name: "OS Family variables"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_iswindows is defined and a2s_iswindows|bool) | ternary('os-family/windows.yml', 'name-of-a-file-that-does-not-exist.yml') }}"
    - "{{ (a2s_vars_osfamily is defined) | ternary(a2s_vars_osfamily, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/{{ ansible_os_family | default('undefined') | lower }}.yml"
    - "os-family/{{ (ansible_os_family is defined) | ternary('untested','unknown') }}.yml"
  tags:
    - always

- name: "OS Family version variables"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_osfamilyversion is defined) | ternary(a2s_vars_osfamilyversion, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/os-family-version/{{ ansible_os_family | default('undefined') | lower }}-{{ ansible_distribution_major_version
      | default('undefined')
      | lower }}.yml"
    - "os-family/os-family-version/no-os-family-version-customization.yml"
  tags:
    - always

- name: "Distribution variables (may override OS Family variables, if exist)"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_distribution is defined) | ternary(a2s_vars_distribution, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/distribution/{{ ansible_distribution | default('undefined') | lower }}.yml"
    - "os-family/distribution/no-os-family-customization.yml"
  tags:
    - always

- name: "Specific version distribution variables (may override OS Family and Distribution variables, if exist)"
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ (a2s_vars_distribution_version is defined) | ternary(a2s_vars_distribution_version, 'name-of-a-file-that-does-not-exist.yml') }}"
    - "os-family/distribution/version/{{ ansible_distribution | default('undefined') | lower }}-{{ ansible_distribution_major_version
      | default('undefined')
      | lower }}.yml"
    - "os-family/distribution/version/no-distribution-customization.yml"
  tags:
    - always

- name: "Result of pre-calculated variables on this play"
  debug:
    msg:
      a2s_default_user: "{{ a2s_default_user | default('undefined') }}"
      a2s_default_group: "{{ a2s_default_group | default('undefined') }}"
      a2s_default_directory_mode: "{{ a2s_default_directory_mode | default('undefined') }}"
      a2s_default_file_mode: "{{ a2s_default_file_mode | default('undefined') }}"
      a2s_isconteiner: "{{ a2s_isconteiner | default('undefined') }}"
      a2s_install_composer: "{{ a2s_install_composer | default(omit) }}"
      a2s_install_php: "{{ a2s_install_php | default(omit) }}"
  tags:
    - always

## Run each ALB Extra subcomponent _____________________________________________

- name: "groups"
  include: groups/main.yml
  when:
    - "(a2s_groups is defined)
      and (a2s_groups[0] is defined)
      and (a2s_groups[0].name is defined)"
  tags:
    - a2s-groups

- name: "users"
  include: users/main.yml
  when:
    - "(a2s_users is defined)
      and (a2s_users[0] is defined)
      and (a2s_users[0].name is defined)"
  tags:
    - a2s-users

- name: "directory"
  include: directory/main.yml
  when:
    - "(a2s_directories is defined)
      and (a2s_directories[0] is defined)
      and (a2s_directories[0].path is defined)"
  tags:
    - a2s-directory
    - a2s-directories

- name: "copy"
  include: copy/main.yml
  when:
    - "(a2s_copies is defined)
      and (a2s_copies[0] is defined)
      and (a2s_copies[0].dest is defined)"
  tags:
    - a2s-copy

- name: "synchronize"
  include: synchronize/main.yml
  when:
    - "(a2s_synchronizes is defined)
      and (a2s_synchronizes[0] is defined)
      and (a2s_synchronizes[0].dest is defined)"
  tags:
    - a2s-copy

- name: "hostname"
  include: hostname/main.yml
  when:
    - "(a2s_hostname is defined)"
  tags:
    - a2s-hostname

- name: "etchosts"
  include: etchosts/main.yml
  when:
    - "(a2s_etchosts is defined) and (a2s_etchosts[0] is defined)"
  tags:
    - a2s-etchosts

- name: "devel-nginx"
  include: devel-nginx/main.yml
  when:
    - "(a2s_internal_devel_nginx_manange is sameas true)"
  tags:
    - a2s-devel-nginx

- name: "php"
  include: php/main.yml
  when:
    - "(a2s_betatesting|bool is sameas true)"
  tags:
    - a2s-php

- name: "composer"
  include: composer/main.yml
  when:
    - "(a2s_betatesting|bool is sameas true)"
  tags:
    - a2s-composer

- name: "adminer"
  include: adminer/main.yml
  when:
    - "(a2s_betatesting|bool is sameas true)"
    - "(a2s_install_adminer is defined)
      and (a2s_install_adminer.download_url is defined)
      and (a2s_install_adminer.install_directory is defined)
      and (a2s_install_adminer.install_file is defined)"
  tags:
    - a2s-adminer

- name: "rclone"
  include: rclone/main.yml
  when:
    - "(a2s_internal_rclone_manange is sameas true)"
  tags:
    - a2s-rclone

- name: "template"
  include: template/main.yml
  when:
    - "(a2s_templates is defined)
      and (a2s_templates[0] is defined)
      and (a2s_templates[0].dest is defined)"
  tags:
    - a2s-template
